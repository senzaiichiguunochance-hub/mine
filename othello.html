<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プレミアム・オセロ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #game-wrapper {
            display: flex;
            border: 2px solid #34495e;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            background-color: #34495e;
            border-radius: 10px;
        }
        #board-container {
            width: 640px;
            height: 640px;
            display: grid;
            grid-template-columns: repeat(8, 80px);
            grid-template-rows: repeat(8, 80px);
            background-color: #004d40;
            padding: 20px;
            border-radius: 8px 0 0 8px;
        }
        .cell {
            width: 80px;
            height: 80px;
            background-color: #00695c;
            border: 1px solid #004d40;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .stone-container {
            width: 70px;
            height: 70px;
            perspective: 1000px;
            position: absolute;
        }
        .stone {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .stone.is-flipped {
            transform: rotateY(180deg);
        }
        .stone-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            backface-visibility: hidden;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.4);
        }
        .stone-face.front { /* Black */
            background: #111;
        }
        .stone-face.back { /* White */
            background: #f0f0f0;
            transform: rotateY(180deg);
        }

        .possible-move::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15);
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.3); opacity: 0.3; }
        }

        #info-panel {
            width: 280px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        h1 { text-align: center; margin-top: 0; }
        .info-box { background: #2c3e50; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        h2 { margin: 0 0 10px 0; font-size: 1.2em; color: #95a5a6; }
        #score-container { display: flex; justify-content: space-around; font-size: 2.2em; font-weight: bold; }
        #message { height: 50px; font-size: 1.1em; color: #e74c3c; text-align: center; }
        button { padding: 15px; font-size: 1.3em; background-color: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        button:hover { background-color: #2ecc71; }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="board-container"></div>
        <div id="info-panel">
            <div>
                <h1>オセロ</h1>
                <div class="info-box">
                    <h2>スコア</h2>
                    <div id="score-container">
                        <div>● <span id="black-score">2</span></div>
                        <div>○ <span id="white-score">2</span></div>
                    </div>
                </div>
                <div class="info-box">
                    <h2>現在のターン</h2>
                    <div id="turn-display" style="font-size: 2.5em; font-weight: bold;">●</div>
                </div>
                <div class="info-box">
                    <h2>メッセージ</h2>
                    <p id="message"></p>
                </div>
            </div>
            <button id="resetButton">リセット</button>
        </div>
    </div>

    <script>
        const boardContainer = document.getElementById('board-container');
        const blackScoreDisplay = document.getElementById('black-score');
        const whiteScoreDisplay = document.getElementById('white-score');
        const turnDisplay = document.getElementById('turn-display');
        const messageDisplay = document.getElementById('message');
        const resetButton = document.getElementById('resetButton');

        const EMPTY = 0, BLACK = 1, WHITE = 2;
        let board = [];
        let currentPlayer = BLACK;
        let gameActive = true;

        const DIRS = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        function init() {
            board = Array(8).fill(0).map(() => Array(8).fill(EMPTY));
            board[3][3] = WHITE; board[3][4] = BLACK;
            board[4][3] = BLACK; board[4][4] = WHITE;
            currentPlayer = BLACK;
            gameActive = true;
            messageDisplay.textContent = '';
            renderBoard();
        }

        function renderBoard() {
            boardContainer.innerHTML = '';
            let blackCount = 0, whiteCount = 0;
            const validMoves = gameActive ? getValidMoves(currentPlayer) : [];

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.r = r; cell.dataset.c = c;

                    const stoneVal = board[r][c];
                    if (stoneVal !== EMPTY) {
                        const stoneContainer = document.createElement('div');
                        stoneContainer.className = 'stone-container';
                        const stone = document.createElement('div');
                        stone.className = 'stone';
                        if (stoneVal === WHITE) stone.classList.add('is-flipped');
                        
                        const front = document.createElement('div');
                        front.className = 'stone-face front';
                        const back = document.createElement('div');
                        back.className = 'stone-face back';
                        
                        stone.appendChild(front);
                        stone.appendChild(back);
                        stoneContainer.appendChild(stone);
                        cell.appendChild(stoneContainer);
                        stoneVal === BLACK ? blackCount++ : whiteCount++;
                    }

                    if (validMoves.some(m => m.r === r && m.c === c)) {
                        cell.classList.add('possible-move');
                        cell.onclick = () => handleCellClick(r, c);
                    }
                    boardContainer.appendChild(cell);
                }
            }
            blackScoreDisplay.textContent = blackCount;
            whiteScoreDisplay.textContent = whiteCount;
            turnDisplay.textContent = currentPlayer === BLACK ? '●' : '○';
            turnDisplay.style.color = currentPlayer === BLACK ? '#111' : '#f0f0f0';
        }

        async function handleCellClick(r, c) {
            if (!gameActive) return;
            
            const player = currentPlayer;
            const flips = getFlips(r, c, player);
            if (flips.length === 0) return;

            gameActive = false;
            messageDisplay.textContent = '';
            
            // --- Animation --- //
            // 1. Place the new stone visually
            const cell = boardContainer.children[r * 8 + c];
            cell.classList.remove('possible-move');
            cell.onclick = null;
            const stoneContainer = document.createElement('div');
            stoneContainer.className = 'stone-container';
            const stone = document.createElement('div');
            stone.className = 'stone';
            if (player === WHITE) stone.classList.add('is-flipped');
            stone.innerHTML = '<div class="stone-face front"></div><div class="stone-face back"></div>';
            stoneContainer.appendChild(stone);
            cell.appendChild(stoneContainer);
            stone.style.transform = (player === WHITE ? 'rotateY(180deg)' : 'rotateY(0deg)') + ' scale(0)';
            await sleep(10);
            stone.style.transform = stone.style.transform.replace(' scale(0)', ' scale(1)');
            await sleep(300);

            // 2. Flip opponent stones
            for (const flip of flips) {
                const flippedStone = boardContainer.children[flip.r * 8 + flip.c].querySelector('.stone');
                if (flippedStone) {
                    flippedStone.classList.toggle('is-flipped');
                }
                await sleep(100);
            }
            await sleep(600);
            // --- End Animation ---

            // Update model after animation
            board[r][c] = player;
            flips.forEach(flip => board[flip.r][flip.c] = player);

            // Switch turn logic
            let nextPlayer = player === BLACK ? WHITE : BLACK;
            let validMoves = getValidMoves(nextPlayer);

            if (validMoves.length === 0) {
                messageDisplay.textContent = `${nextPlayer === BLACK ? '黒' : '白'}のパスです。`;
                await sleep(1500);
                nextPlayer = player; // Pass back
                validMoves = getValidMoves(nextPlayer);
                if (validMoves.length === 0) {
                    endGame();
                    return;
                }
            }
            currentPlayer = nextPlayer;
            gameActive = true;
            renderBoard();
        }

        function getValidMoves(player) {
            const moves = [];
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (board[r][c] === EMPTY && getFlips(r, c, player).length > 0) {
                        moves.push({ r, c });
                    }
                }
            }
            return moves;
        }

        function getFlips(r, c, player) {
            const opponent = player === BLACK ? WHITE : BLACK;
            let allFlips = [];
            for (const [dr, dc] of DIRS) {
                let line = [];
                let cr = r + dr, cc = c + dc;
                while (cr >= 0 && cr < 8 && cc >= 0 && cc < 8 && board[cr][cc] === opponent) {
                    line.push({ r: cr, c: cc });
                    cr += dr; cc += dc;
                }
                if (line.length > 0 && cr >= 0 && cr < 8 && cc >= 0 && cc < 8 && board[cr][cc] === player) {
                    allFlips.push(...line);
                }
            }
            return allFlips;
        }

        function endGame() {
            gameActive = false;
            const black = board.flat().filter(s => s === BLACK).length;
            const white = board.flat().filter(s => s === WHITE).length;
            let msg = '引き分け';
            if (black > white) msg = '黒の勝ち！';
            if (white > black) msg = '白の勝ち！';
            messageDisplay.textContent = `ゲーム終了！ ${msg}`;
        }

        resetButton.addEventListener('click', init);
        init();
    </script>
</body>
</html>
